#!/usr/bin/env bash

echo "
███╗   ██╗███████╗████████╗██╗    ██╗ ██████╗ ██████╗ ██╗  ██╗    ██████╗ ███████╗██╗   ██╗██╗ ██████╗███████╗
████╗  ██║██╔════╝╚══██╔══╝██║    ██║██╔═══██╗██╔══██╗██║ ██╔╝    ██╔══██╗██╔════╝██║   ██║██║██╔════╝██╔════╝
██╔██╗ ██║█████╗     ██║   ██║ █╗ ██║██║   ██║██████╔╝█████╔╝     ██║  ██║█████╗  ██║   ██║██║██║     █████╗
██║╚██╗██║██╔══╝     ██║   ██║███╗██║██║   ██║██╔══██╗██╔═██╗     ██║  ██║██╔══╝  ╚██╗ ██╔╝██║██║     ██╔══╝
██║ ╚████║███████╗   ██║   ╚███╔███╔╝╚██████╔╝██║  ██║██║  ██╗    ██████╔╝███████╗ ╚████╔╝ ██║╚██████╗███████╗
╚═╝  ╚═══╝╚══════╝   ╚═╝    ╚══╝╚══╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝    ╚═════╝ ╚══════╝  ╚═══╝  ╚═╝ ╚═════╝╚══════╝

██╗███╗   ██╗██╗   ██╗███████╗███╗   ██╗████████╗ ██████╗ ██████╗ ██╗   ██╗
██║████╗  ██║██║   ██║██╔════╝████╗  ██║╚══██╔══╝██╔═══██╗██╔══██╗╚██╗ ██╔╝
██║██╔██╗ ██║██║   ██║█████╗  ██╔██╗ ██║   ██║   ██║   ██║██████╔╝ ╚████╔╝
██║██║╚██╗██║╚██╗ ██╔╝██╔══╝  ██║╚██╗██║   ██║   ██║   ██║██╔══██╗  ╚██╔╝
██║██║ ╚████║ ╚████╔╝ ███████╗██║ ╚████║   ██║   ╚██████╔╝██║  ██║   ██║
╚═╝╚═╝  ╚═══╝  ╚═══╝  ╚══════╝╚═╝  ╚═══╝   ╚═╝    ╚═════╝ ╚═╝  ╚═╝   ╚═╝

███████╗██╗  ██╗   ██╗██╗    ██╗ █████╗ ██╗   ██╗    ██████╗ ██████╗     ███████╗ ██████╗██╗  ██╗███████╗███╗   ███╗ █████╗
██╔════╝██║  ╚██╗ ██╔╝██║    ██║██╔══██╗╚██╗ ██╔╝    ██╔══██╗██╔══██╗    ██╔════╝██╔════╝██║  ██║██╔════╝████╗ ████║██╔══██╗
█████╗  ██║   ╚████╔╝ ██║ █╗ ██║███████║ ╚████╔╝     ██║  ██║██████╔╝    ███████╗██║     ███████║█████╗  ██╔████╔██║███████║
██╔══╝  ██║    ╚██╔╝  ██║███╗██║██╔══██║  ╚██╔╝      ██║  ██║██╔══██╗    ╚════██║██║     ██╔══██║██╔══╝  ██║╚██╔╝██║██╔══██║
██║     ███████╗██║   ╚███╔███╔╝██║  ██║   ██║       ██████╔╝██████╔╝    ███████║╚██████╗██║  ██║███████╗██║ ╚═╝ ██║██║  ██║
╚═╝     ╚══════╝╚═╝    ╚══╝╚══╝ ╚═╝  ╚═╝   ╚═╝       ╚═════╝ ╚═════╝     ╚══════╝ ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝

███╗   ███╗██╗ ██████╗ ██████╗  █████╗ ████████╗██╗ ██████╗ ███╗   ██╗
████╗ ████║██║██╔════╝ ██╔══██╗██╔══██╗╚══██╔══╝██║██╔═══██╗████╗  ██║
██╔████╔██║██║██║  ███╗██████╔╝███████║   ██║   ██║██║   ██║██╔██╗ ██║
██║╚██╔╝██║██║██║   ██║██╔══██╗██╔══██║   ██║   ██║██║   ██║██║╚██╗██║
██║ ╚═╝ ██║██║╚██████╔╝██║  ██║██║  ██║   ██║   ██║╚██████╔╝██║ ╚████║
╚═╝     ╚═╝╚═╝ ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝"

# Declarations Section ============================
declare -a options=(
	"Flyway DB Schema Migration"
	"quit"
)


# Functions Section ============================

## Reminder Message
warningMessage() {
echo -e "SQL Migration file is required for this procedure. It should be added in : deployment/flyway/sql_versions"
echo -e "In order to be picked up by Flyway, SQL migration file must comply with a certain naming convention : https://flywaydb.org/documentation/concepts/migrations.html#naming"
}

## Make Sure The User is Ready to Migrate
isReadyToMigrate() {
read -r -p "Continue ? [y|n] " response
until [[ ${response^} =~ 'Y' ]]
do
  read -r -p "Seems like you are not ready :( !  How about now ? [y|n] " response
done
}

## Flyway Up, Execute SQL Migration, Log 10 line then Down.
runDockerCommands() {
docker-compose --env-file .env up -d flyway;
# Sleep 10 S
sleep 10;
# 10 of lines to show from the end of the logs
docker-compose logs -t --tail 10 flyway;
}

# Main Section ============================
echo

echo $(uname) ": Hi 😊 ! please make a selection."

echo

select option in "${options[@]}"

do

  case ${option} in

    # Choice : 1
    "Flyway DB Schema Migration")
          warningMessage;
          isReadyToMigrate;
          echo "Flyway DB Schema Migration...";
          runDockerCommands;
          break;;

    # Choice : 2
    quit)
          echo $(uname) ": Bye !" ;
          break;;

    # Choice : Default
    *)
          echo $(uname) ": I'm not sure what that is O.Ô !"
  esac

done